<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chen.log.server.dao.OperationDao">

    <resultMap id="baseResultMap" type="com.chen.log.server.po.Operation">
        <id column="id" jdbcType="CHAR" property="id" />
        <result column="app_name" jdbcType="VARCHAR" property="appName" />
        <result column="table_name" jdbcType="VARCHAR" property="tableName" />
        <result column="object_id" jdbcType="VARCHAR" property="objectId" />
        <result column="operator_id" jdbcType="VARCHAR" property="operatorId" />
        <result column="operator" jdbcType="VARCHAR" property="operator" />
        <result column="operation_type" jdbcType="VARCHAR" property="operationType" />
        <result column="operation_alias" jdbcType="VARCHAR" property="operationAlias" />
        <result column="remark" jdbcType="VARCHAR" property="remark" />
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    </resultMap>

    <select id="queryByFilter" parameterType="com.chen.log.server.po.Operation" resultMap="baseResultMap">
        SELECT * FROM ${tableName}
        <where>
            <if test="operation.id != null and operation.id != '' ">
                `id`=#{operation.id}
            </if>
            <if test="operation.appName != null and operation.appName != ''">
                AND `app_name`= #{operation.appName}
            </if>
            <if test="operation.tableName != null and operation.tableName != ''">
                AND `table_name` like '%${operation.tableName}%'
            </if>
            <if test="operation.objectId != null and operation.objectId != ''">
                AND `object_id`=#{operation.objectId}
            </if>
            <if test="operation.operator != null and operation.operator != '' ">
                AND `operator` like '%${operation.operator}%'
            </if>
            <if test="operation.operationType != null and operation.operationType != '' ">
                AND `operation_type`=#{operation.operationType}
            </if>
            <if test="operation.operationAlias != null and operation.operationAlias != ''">
                AND `operation_alias` like '${operation.operationAlias}'
            </if>
            <if test="operation.remark != null">
                AND `remark`=#{operation.remark}
            </if>
            <if test="operation.comment != null">
                AND `comment`=#{operation.comment}
            </if>
            <if test="operation.createTime != null">
                AND `create_time`=#{operation.createTime}
            </if>
        </where>
        ORDER BY `create_time` desc
    </select>

    <insert id="insertSelective" parameterType="com.chen.log.server.po.Operation">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jun 15 13:58:54 CST 2020.
        -->
        insert into `operation_${appName}`
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="appName != null">
                app_name,
            </if>
            <if test="tableName != null">
                table_name,
            </if>
            <if test="objectId != null">
                object_id,
            </if>
            <if test="groupId != null">
                group_id,
            </if>
            <if test="operatorId != null">
                operator_id,
            </if>
            <if test="operator != null">
                operator,
            </if>
            <if test="operationType != null">
                operation_type,
            </if>
            <if test="operationAlias != null">
                operation_alias,
            </if>
            <if test="remark != null">
                remark,
            </if>
            <if test="createTime != null">
                create_time,
            </if>
            <if test="comment != null">
                comment,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=CHAR},
            </if>
            <if test="appName != null">
                #{appName,jdbcType=VARCHAR},
            </if>
            <if test="tableName != null">
                #{tableName,jdbcType=VARCHAR},
            </if>
            <if test="objectId != null">
                #{objectId,jdbcType=VARCHAR},
            </if>
            <if test="groupId != null">
                #{groupId,jdbcType=VARCHAR},
            </if>
            <if test="operatorId != null">
                #{operatorId,jdbcType=VARCHAR},
            </if>
            <if test="operator != null">
                #{operator,jdbcType=VARCHAR},
            </if>
            <if test="operationType != null">
                #{operationType,jdbcType=VARCHAR},
            </if>
            <if test="operationAlias != null">
                #{operationAlias,jdbcType=VARCHAR},
            </if>
            <if test="remark != null">
                #{remark,jdbcType=VARCHAR},
            </if>
            <if test="createTime != null">
                #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="comment != null">
                #{comment,jdbcType=LONGVARCHAR},
            </if>
        </trim>
    </insert>


    <select id="existTable" parameterType="java.lang.String" resultType="java.lang.Integer">
      select COUNT(0) count from information_schema.`TABLES` where TABLE_NAME = #{tableName} and TABLE_SCHEMA = 'operate_log'
    </select>

    <!-- 动态创建操作表 -->
    <update id="create" parameterType="java.lang.String">
        CREATE TABLE ${tableName} (
          `id` char(22) NOT NULL,
          `app_name` varchar(30) DEFAULT '' COMMENT '服务的名字，比如 lianlianche-finance',
          `table_name` varchar(30) NOT NULL DEFAULT '' COMMENT '所对应操作的类名 比如车金融的apply表',
          `object_id` varchar(22) NOT NULL DEFAULT '' COMMENT '比如 applyId',
          `group_id` varchar(22) NOT NULL DEFAULT '' COMMENT '分组id',
          `operator_id` varchar(30) NOT NULL DEFAULT '' COMMENT '操作人id',
          `operator` varchar(30) NOT NULL DEFAULT '' COMMENT '操作人名字',
          `operation_type` varchar(30) NOT NULL DEFAULT '' COMMENT '操作类型名称，比如，更新  修改 保存',
          `operation_alias` varchar(30) NOT NULL DEFAULT '' COMMENT '操作的别名',
          `remark` varchar(1000) DEFAULT '' COMMENT '备注',
          `comment` mediumtext,
          `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
          PRIMARY KEY (`id`),
          KEY `app_name` (`app_name`) USING HASH,
          KEY `table_name` (`table_name`) USING HASH,
          KEY `object_id` (`object_id`) USING BTREE
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='操作表';
    </update>

    <update id="update">
        UPDATE operation_finance SET `app_name`=#{appName} WHERE (`id`= #{id});
    </update>
</mapper>
